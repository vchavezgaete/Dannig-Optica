generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Cliente {
  idCliente       Int      @id @default(autoincrement()) @map("id_cliente")
  rut             String   @unique(map: "uq_cliente_rut") @db.VarChar(12)
  nombres         String   @db.VarChar(100)
  apellidoPaterno String   @map("apellido_paterno") @db.VarChar(50)
  apellidoMaterno String?  @map("apellido_materno") @db.VarChar(50)
  telefono        String?  @db.VarChar(15)
  correo          String?  @db.VarChar(120)
  calle           String?  @db.VarChar(100)
  numero          String?  @db.VarChar(20)
  departamento    String?  @db.VarChar(20)
  idSector        Int?     @map("id_sector")
  sector          Sector?  @relation(fields: [idSector], references: [idSector], onDelete: SetNull, map: "fk_cliente_sector")
  idComuna        Int?     @map("id_comuna")
  comuna          Comuna?  @relation(fields: [idComuna], references: [idComuna], onDelete: NoAction, map: "fk_cliente_comuna")
  fechaCreacion   DateTime @default(now()) @map("fecha_creacion") @db.DateTime(0)
  fechaActualizacion DateTime @default(now()) @updatedAt @map("fecha_actualizacion") @db.DateTime(0)
  idVendedor      Int?     @map("id_vendedor")
  vendedor        Usuario? @relation(fields: [idVendedor], references: [idUsuario], onDelete: NoAction, map: "fk_cliente_vendedor")
  alertas         Alerta[]
  citas           Cita[]
  ventas          Venta[]

  @@index([idVendedor], map: "fk_cliente_vendedor")
  @@index([idComuna], map: "fk_cliente_comuna")
  @@index([idSector], map: "fk_cliente_sector")
  @@map("cliente")
}

model Operativo {
  idOperativo Int      @id @default(autoincrement()) @map("id_operativo")
  nombre      String   @db.VarChar(120)
  fecha       DateTime @db.Date
  lugar       String?  @db.VarChar(150)
  cupos       Int?
  idComuna    Int?     @map("id_comuna")
  comuna      Comuna?  @relation(fields: [idComuna], references: [idComuna], onDelete: SetNull, map: "fk_operativo_comuna")
  citas       Cita[]

  @@index([idComuna], map: "fk_operativo_comuna")
  @@map("operativo")
}

model Usuario {
  idUsuario        Int          @id @default(autoincrement()) @map("id_usuario")
  nombres          String       @db.VarChar(100)
  apellidoPaterno  String       @map("apellido_paterno") @db.VarChar(50)
  apellidoMaterno  String?      @map("apellido_materno") @db.VarChar(50)
  correo           String       @unique(map: "uq_usuario_correo") @db.VarChar(120)
  hashPassword     String       @map("hash_password") @db.VarChar(255)
  activo           Int          @default(1) @db.TinyInt
  roles            UsuarioRol[]
  clientesCaptados Cliente[]
  citasAsignadas   Cita[]
  auditorias       Auditoria[]

  @@map("usuario")
}

model Rol {
  idRol    Int          @id @default(autoincrement()) @map("id_rol")
  nombre   String       @unique(map: "uq_rol_nombre") @db.VarChar(50)
  usuarios UsuarioRol[]

  @@map("rol")
}

model UsuarioRol {
  idUsuario Int     @map("id_usuario")
  idRol     Int     @map("id_rol")
  rol       Rol     @relation(fields: [idRol], references: [idRol], onDelete: Cascade, map: "fk_ur_rol")
  usuario   Usuario @relation(fields: [idUsuario], references: [idUsuario], onDelete: Cascade, map: "fk_ur_usuario")

  @@id([idUsuario, idRol])
  @@index([idRol], map: "fk_ur_rol")
  @@map("usuario_rol")
}

model Cita {
  idCita      Int           @id @default(autoincrement()) @map("id_cita")
  idCliente   Int           @map("id_cliente")
  idOperativo Int?          @map("id_operativo")
  idMedico    Int?          @map("id_medico")
  fechaHora   DateTime      @map("fecha_hora") @db.DateTime(0)
  estado      CitaEstado
  cliente     Cliente       @relation(fields: [idCliente], references: [idCliente], onDelete: NoAction, map: "fk_cita_cliente")
  operativo   Operativo?    @relation(fields: [idOperativo], references: [idOperativo], onDelete: NoAction, map: "fk_cita_operativo")
  medico      Usuario?      @relation(fields: [idMedico], references: [idUsuario], onDelete: NoAction, map: "fk_cita_medico")
  ficha       FichaClinica?

  @@index([idCliente, fechaHora], map: "ix_cita_cliente_fecha")
  @@index([idOperativo, fechaHora], map: "ix_cita_operativo_fecha")
  @@index([idMedico], map: "fk_cita_medico")
  @@map("cita")
}

model FichaClinica {
  idFicha                    Int      @id @default(autoincrement()) @map("id_ficha")
  idCita                     Int      @unique(map: "uq_ficha_cita") @map("id_cita")
  observaciones              String?  @db.Text
  fechaRegistro              DateTime @default(now()) @map("fecha_registro") @db.DateTime(0)
  cita                       Cita     @relation(fields: [idCita], references: [idCita], onDelete: Cascade, map: "fk_ficha_cita")
  recetas                    Receta[]
  antecedentes               FichaAntecedente[]

  @@map("ficha_clinica")
}

model Antecedente {
  idAntecedente Int      @id @default(autoincrement()) @map("id_antecedente")
  nombre        String   @unique(map: "uq_antecedente_nombre") @db.VarChar(100)
  tipo          String?  @db.VarChar(50) // 'General', 'Oftalmologico'
  fichas        FichaAntecedente[]

  @@map("antecedente")
}

model FichaAntecedente {
  idFicha       Int          @map("id_ficha")
  idAntecedente Int          @map("id_antecedente")
  observacion   String?      @db.VarChar(255)
  ficha         FichaClinica @relation(fields: [idFicha], references: [idFicha], onDelete: Cascade, map: "fk_fa_ficha")
  antecedente   Antecedente  @relation(fields: [idAntecedente], references: [idAntecedente], onDelete: Cascade, map: "fk_fa_antecedente")

  @@id([idFicha, idAntecedente])
  @@index([idAntecedente], map: "fk_fa_antecedente")
  @@map("ficha_antecedente")
}

model Receta {
  idReceta     Int          @id @default(autoincrement()) @map("id_receta")
  idFicha      Int          @map("id_ficha")
  odEsfera     Decimal?     @map("od_esfera") @db.Decimal(4, 2)
  odCilindro   Decimal?     @map("od_cilindro") @db.Decimal(4, 2)
  odEje        Int?         @map("od_eje") @db.SmallInt
  oiEsfera     Decimal?     @map("oi_esfera") @db.Decimal(4, 2)
  oiCilindro   Decimal?     @map("oi_cilindro") @db.Decimal(4, 2)
  oiEje        Int?         @map("oi_eje") @db.SmallInt
  adicion      Decimal?     @db.Decimal(3, 2)
  pd           Decimal?     @db.Decimal(4, 2)
  vigenciaDias Int?         @map("vigencia_dias")
  fechaEmision DateTime     @default(dbgenerated("(curdate())")) @map("fecha_emision") @db.Date
  ficha        FichaClinica @relation(fields: [idFicha], references: [idFicha], onDelete: Cascade, map: "fk_receta_ficha")
  ventas       Venta[]

  @@index([idFicha], map: "fk_receta_ficha")
  @@map("receta")
}

model Producto {
  idProducto  Int                @id @default(autoincrement()) @map("id_producto")
  codigo      String             @unique(map: "uq_producto_codigo") @db.VarChar(50)
  nombre      String             @db.VarChar(120)
  precio      Decimal            @db.Decimal(10, 2)
  idCategoria Int?               @map("id_categoria")
  categoria   CategoriaProducto? @relation(fields: [idCategoria], references: [idCategoria], onDelete: SetNull, map: "fk_producto_categoria")
  items       ItemVenta[]

  @@index([idCategoria], map: "fk_producto_categoria")
  @@map("producto")
}

model CategoriaProducto {
  idCategoria Int        @id @default(autoincrement()) @map("id_categoria")
  nombre      String     @unique(map: "uq_categoria_nombre") @db.VarChar(50)
  productos   Producto[]

  @@map("categoria_producto")
}

model Venta {
  idVenta        Int            @id @default(autoincrement()) @map("id_venta")
  idCliente      Int            @map("id_cliente")
  idReceta       Int?           @map("id_receta")
  fechaVenta     DateTime       @default(now()) @map("fecha_venta") @db.DateTime(0)
  total          Decimal        @db.Decimal(10, 2)
  tipoDocumento  TipoDocumento? @map("tipo_documento")
  items          ItemVenta[]
  cliente        Cliente        @relation(fields: [idCliente], references: [idCliente], onDelete: NoAction, map: "fk_venta_cliente")
  receta         Receta?        @relation(fields: [idReceta], references: [idReceta], map: "fk_venta_receta")

  @@index([idCliente, fechaVenta], map: "ix_venta_cliente_fecha")
  @@index([idReceta], map: "fk_venta_receta")
  @@map("venta")
}

model ItemVenta {
  idItem         Int       @id @default(autoincrement()) @map("id_item")
  idVenta        Int       @map("id_venta")
  idProducto     Int       @map("id_producto")
  cantidad       Int
  precioUnitario Decimal   @map("precio_unitario") @db.Decimal(10, 2)
  garantia       Garantia?
  producto       Producto  @relation(fields: [idProducto], references: [idProducto], onDelete: NoAction, map: "fk_item_producto")
  venta          Venta     @relation(fields: [idVenta], references: [idVenta], onDelete: Cascade, map: "fk_item_venta")

  @@index([idVenta], map: "ix_item_venta")
  @@index([idProducto], map: "fk_item_producto")
  @@map("item_venta")
}

model Garantia {
  idGarantia  Int       @id @default(autoincrement()) @map("id_garantia")
  idItem      Int       @unique(map: "uq_garantia_item") @map("id_item")
  fechaInicio DateTime  @map("fecha_inicio") @db.Date
  fechaFin    DateTime  @map("fecha_fin") @db.Date
  condiciones String?   @db.Text
  item        ItemVenta @relation(fields: [idItem], references: [idItem], onDelete: Cascade, map: "fk_garantia_item")

  @@map("garantia")
}

model Alerta {
  idAlerta        Int         @id @default(autoincrement()) @map("id_alerta")
  idCliente       Int         @map("id_cliente")
  tipo            AlertaTipo
  canal           AlertaCanal
  mensaje         String      @db.VarChar(240)
  fechaProgramada DateTime    @map("fecha_programada") @db.DateTime(0)
  enviado         Int         @default(0) @db.TinyInt
  cliente         Cliente     @relation(fields: [idCliente], references: [idCliente], onDelete: NoAction, map: "fk_alerta_cliente")

  @@index([fechaProgramada, enviado], map: "ix_alerta_programada")
  @@index([idCliente], map: "fk_alerta_cliente")
  @@map("alerta")
}

model Region {
  idRegion Int      @id @default(autoincrement()) @map("id_region")
  nombre   String   @unique(map: "uq_region_nombre") @db.VarChar(100)
  ordinal  String?  @db.VarChar(10) 
  comunas  Comuna[]

  @@map("region")
}

model Comuna {
  idComuna   Int         @id @default(autoincrement()) @map("id_comuna")
  nombre     String      @unique(map: "uq_comuna_nombre") @db.VarChar(100)
  idRegion   Int         @map("id_region")
  region     Region      @relation(fields: [idRegion], references: [idRegion], onDelete: NoAction, map: "fk_comuna_region")
  sectores   Sector[]
  clientes   Cliente[]
  operativos Operativo[]

  @@index([idRegion], map: "fk_comuna_region")
  @@map("comuna")
}

model Sector {
  idSector  Int      @id @default(autoincrement()) @map("id_sector")
  nombre    String   @db.VarChar(100)
  idComuna  Int      @map("id_comuna")
  comuna    Comuna   @relation(fields: [idComuna], references: [idComuna], onDelete: Cascade, map: "fk_sector_comuna")
  clientes  Cliente[]

  @@index([idComuna], map: "fk_sector_comuna")
  @@map("sector")
}

enum CitaEstado {
  Programada
  Confirmada
  Atendida
  NoShow     @map("No-show")
  Cancelada
}

enum AlertaTipo {
  Control
  Garantia  @map("Garant√≠a")
  Operativo
}

enum AlertaCanal {
  SMS
  Correo
}

enum TipoDocumento {
  Boleta
  Factura
}

model Auditoria {
  idAuditoria    Int       @id @default(autoincrement()) @map("id_auditoria")
  idUsuario      Int?      @map("id_usuario")
  tabla          String    @db.VarChar(50)
  operacion      String    @db.VarChar(20) // CREATE, UPDATE, DELETE
  registroId     String?   @map("registro_id") @db.VarChar(50)
  datosAnteriores String?  @map("datos_anteriores") @db.Text
  datosNuevos    String?   @map("datos_nuevos") @db.Text
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  userAgent      String?   @map("user_agent") @db.VarChar(255)
  fechaHora      DateTime  @default(now()) @map("fecha_hora") @db.DateTime(0)
  usuario        Usuario?  @relation(fields: [idUsuario], references: [idUsuario], onDelete: SetNull, map: "fk_auditoria_usuario")

  @@index([idUsuario], map: "fk_auditoria_usuario")
  @@index([tabla, operacion], map: "ix_auditoria_tabla_operacion")
  @@index([fechaHora], map: "ix_auditoria_fecha")
  @@map("auditoria")
}

model Configuracion {
  idConfiguracion Int       @id @default(autoincrement()) @map("id_configuracion")
  clave            String    @unique(map: "uq_configuracion_clave") @db.VarChar(100)
  valor            String    @db.Text
  descripcion      String?   @db.VarChar(255)
  tipo             String    @default("string") @db.VarChar(20) // string, number, boolean, json
  fechaModificacion DateTime @default(now()) @updatedAt @map("fecha_modificacion") @db.DateTime(0)

  @@map("configuracion")
}
