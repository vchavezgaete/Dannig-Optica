version: '3.8'

# Este archivo configura Dannig Óptica para usar el Traefik principal
# que ya está funcionando en puertos 80/443

services:
  # Base de datos MySQL
  mysql:
    image: mysql:8.0
    container_name: dannig-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-dannig}
      - MYSQL_USER=${MYSQL_USER:-dannig}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-dannig}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - dannig-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Adminer - DB Admin
  adminer:
    image: adminer:latest
    container_name: dannig-adminer
    networks:
      - dannig-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dannig-adminer.rule=Host(`db.Dannig-Optica.freeddns.org`) || Host(`db.dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-adminer.entrypoints=websecure"
      - "traefik.http.routers.dannig-adminer.tls.certresolver=letsencrypt"
      - "traefik.http.services.dannig-adminer.loadbalancer.server.port=8080"

  # Backend API
  backend:
    build: ./backend
    container_name: dannig-backend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=mysql://${MYSQL_USER:-dannig}:${MYSQL_PASSWORD:-dannig}@mysql:3306/${MYSQL_DATABASE:-dannig}
      - JWT_SECRET=${JWT_SECRET:-secure-token-change-in-production}
      # Admin user credentials
      - ADMIN_NAME=${ADMIN_NAME:-Admin}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@dannig.local}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      # Captador user credentials
      - CAPTADOR_NAME=${CAPTADOR_NAME:-Captador}
      - CAPTADOR_EMAIL=${CAPTADOR_EMAIL:-captador@dannig.local}
      - CAPTADOR_PASSWORD=${CAPTADOR_PASSWORD:-captador123}
      # Oftalmólogo user credentials
      - OFTALMOLOGO_NAME=${OFTALMOLOGO_NAME:-Dr. Oftalmólogo}
      - OFTALMOLOGO_EMAIL=${OFTALMOLOGO_EMAIL:-oftalmologo@dannig.local}
      - OFTALMOLOGO_PASSWORD=${OFTALMOLOGO_PASSWORD:-oftalmologo123}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - dannig-network
    restart: unless-stopped
    volumes:
      - ./backend/logs:/app/logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dannig-backend.rule=Host(`api.Dannig-Optica.freeddns.org`) || Host(`api.dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-backend.entrypoints=websecure"
      - "traefik.http.routers.dannig-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.dannig-backend.loadbalancer.server.port=3001"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.dannig-backend-http.rule=Host(`api.Dannig-Optica.freeddns.org`) || Host(`api.dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-backend-http.entrypoints=web"
      - "traefik.http.routers.dannig-backend-http.middlewares=redirect-dannig-backend-to-https"
      - "traefik.http.middlewares.redirect-dannig-backend-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-dannig-backend-to-https.redirectscheme.permanent=true"

  # Frontend React
  frontend:
    build:
      context: ./frontend
      args:
        # Sin puerto porque el Traefik principal usa 80/443 estándar
        - VITE_API_URL=${VITE_API_URL:-https://api.Dannig-Optica.freeddns.org}
    container_name: dannig-frontend
    depends_on:
      - backend
    networks:
      - dannig-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dannig-frontend.rule=Host(`app.Dannig-Optica.freeddns.org`) || Host(`app.dannig-optica.freeddns.org`) || Host(`Dannig-Optica.freeddns.org`) || Host(`dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-frontend.entrypoints=websecure"
      - "traefik.http.routers.dannig-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dannig-frontend.priority=100"
      - "traefik.http.routers.dannig-frontend.service=dannig-frontend-svc"
      - "traefik.http.services.dannig-frontend-svc.loadbalancer.server.port=80"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.dannig-frontend-http.rule=Host(`app.Dannig-Optica.freeddns.org`) || Host(`app.dannig-optica.freeddns.org`) || Host(`Dannig-Optica.freeddns.org`) || Host(`dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-frontend-http.entrypoints=web"
      - "traefik.http.routers.dannig-frontend-http.middlewares=redirect-dannig-frontend-to-https"
      - "traefik.http.middlewares.redirect-dannig-frontend-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-dannig-frontend-to-https.redirectscheme.permanent=true"

volumes:
  mysql_data:
    driver: local

networks:
  dannig-network:
    driver: bridge
    # Conectar esta red al Traefik principal
    # El Traefik principal debe poder ver estos contenedores

