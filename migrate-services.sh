#!/bin/bash

# Script para migrar servicios existentes y permitir que Traefik use Let's Encrypt
# Este script detecta servicios en puertos 80/443 y ayuda a reubicarlos

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸ”„ MigraciÃ³n de Servicios para Let's Encrypt"
echo "=============================================="
echo ""

# Check if running as root for port detection
if [ "$EUID" -ne 0 ] && ! sudo -n true 2>/dev/null; then
  echo "âš ï¸  Este script necesita permisos de administrador para detectar servicios"
  echo "   Se ejecutarÃ¡ con sudo cuando sea necesario"
  echo ""
fi

# Function to detect services on ports
detect_port_usage() {
  local port=$1
  local services=()
  
  if sudo ss -tulpn 2>/dev/null | grep -q ":${port} "; then
    sudo ss -tulpn 2>/dev/null | grep ":${port} " | while read line; do
      pid=$(echo "$line" | grep -oP 'pid=\K[0-9]+')
      process=$(ps -p "$pid" -o comm= 2>/dev/null || echo "unknown")
      echo "$process (PID: $pid)"
    done
  fi
}

echo "ğŸ” Detectando servicios en puertos 80 y 443..."
echo ""

PORT80_SERVICES=$(sudo ss -tulpn 2>/dev/null | grep ":80 " | head -5 || echo "")
PORT443_SERVICES=$(sudo ss -tulpn 2>/dev/null | grep ":443 " | head -5 || echo "")

if [ -n "$PORT80_SERVICES" ]; then
  echo "âš ï¸  Puerto 80 estÃ¡ en uso:"
  echo "$PORT80_SERVICES" | while read line; do
    echo "   $line"
  done
  echo ""
fi

if [ -n "$PORT443_SERVICES" ]; then
  echo "âš ï¸  Puerto 443 estÃ¡ en uso:"
  echo "$PORT443_SERVICES" | while read line; do
    echo "   $line"
  done
  echo ""
fi

if [ -z "$PORT80_SERVICES" ] && [ -z "$PORT443_SERVICES" ]; then
  echo "âœ… Los puertos 80 y 443 estÃ¡n libres!"
  echo ""
  echo "Puedes usar Let's Encrypt directamente con:"
  echo "  ./start-traefik.sh"
  exit 0
fi

echo "ğŸ’¡ Opciones para liberar puertos 80 y 443:"
echo ""
echo "1. Mover servicios existentes a puertos alternativos"
echo "2. Configurar Traefik como proxy Ãºnico y mover servicios detrÃ¡s de Ã©l"
echo "3. Usar port forwarding con iptables (avanzado)"
echo ""
read -p "Selecciona una opciÃ³n (1-3): " choice

case $choice in
  1)
    echo ""
    echo "ğŸ“ OpciÃ³n 1: Mover servicios a puertos alternativos"
    echo ""
    echo "NecesitarÃ¡s:"
    echo "- Identificar quÃ© servicios usan 80/443"
    echo "- Modificar su configuraciÃ³n para usar puertos alternativos"
    echo "- Actualizar cualquier referencia a esos servicios"
    echo ""
    echo "Puertos recomendados:"
    echo "  - HTTP alternativo: 8080, 8888, 9000"
    echo "  - HTTPS alternativo: 8443, 9443"
    echo ""
    read -p "Â¿Continuar? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo ""
      echo "ğŸ“‹ Siguiente: Edita manualmente la configuraciÃ³n de tus servicios"
      echo "   y muÃ©velos a puertos alternativos, luego ejecuta ./start-traefik.sh"
    fi
    ;;
    
  2)
    echo ""
    echo "ğŸ“ OpciÃ³n 2: Traefik como Proxy Ãšnico"
    echo ""
    echo "Esta opciÃ³n configura Traefik para:"
    echo "- Recibir todo el trÃ¡fico en 80/443"
    echo "- Enrutar a servicios existentes por hostname/path"
    echo "- Usar Let's Encrypt para certificados SSL"
    echo ""
    
    # Ask for existing services
    echo "Â¿QuÃ© servicios quieres mantener detrÃ¡s de Traefik?"
    echo ""
    read -p "Servicio 1 hostname (ej: servicio1.local): " host1
    read -p "Servicio 1 puerto interno (ej: 8001): " port1
    read -p "Servicio 1 path opcional (ej: /app o dejar vacÃ­o): " path1
    
    echo ""
    echo "Creando configuraciÃ³n de Traefik para servicio existente..."
    
    # Create additional traefik config
    cat > traefik/dynamic-routes.yml <<EOF
# Dynamic routes for existing services
# Generated by migrate-services.sh

http:
  routers:
    existing-service-1:
      rule: "Host(\`${host1}\`)${path1:+ && PathPrefix(\`${path1}\`)}"
      entryPoints:
        - websecure
      service: existing-service-1-svc
      tls:
        certResolver: letsencrypt
    existing-service-1-http:
      rule: "Host(\`${host1}\`)${path1:+ && PathPrefix(\`${path1}\`)}"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: existing-service-1-svc

  services:
    existing-service-1-svc:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:${port1}"
EOF

    echo "âœ… ConfiguraciÃ³n creada en traefik/dynamic-routes.yml"
    echo ""
    echo "Nota: NecesitarÃ¡s:"
    echo "1. Asegurar que el servicio en puerto ${port1} estÃ¡ accesible desde Docker"
    echo "2. Agregar el volumen a docker-compose.traefik.yml:"
    echo "   - ./traefik/dynamic-routes.yml:/dynamic-routes.yml:ro"
    echo "3. Agregar al comando de Traefik:"
    echo "   - \"--providers.file.filename=/dynamic-routes.yml\""
    echo ""
    ;;
    
  3)
    echo ""
    echo "ğŸ“ OpciÃ³n 3: Port Forwarding con iptables"
    echo ""
    echo "Esta opciÃ³n usa iptables para redirigir:"
    echo "- Puerto 80 â†’ Servicio existente (puerto alternativo)"
    echo "- Puerto 443 â†’ Traefik (para Let's Encrypt)"
    echo ""
    echo "âš ï¸  Requiere permisos root y configuraciÃ³n manual de iptables"
    echo ""
    read -p "Â¿Continuar con configuraciÃ³n manual? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo ""
      echo "Ejemplo de reglas iptables:"
      echo ""
      echo "# Redirigir HTTP (80) a servicio en 8080"
      echo "sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080"
      echo ""
      echo "# Permitir que Traefik escuche en 443"
      echo "# (Traefik se configura normalmente en docker-compose)"
      echo ""
      echo "âš ï¸  Estas reglas se perderÃ¡n al reiniciar. Considera hacerlas persistentes."
    fi
    ;;
    
  *)
    echo "âŒ OpciÃ³n invÃ¡lida"
    exit 1
    ;;
esac

echo ""
echo "âœ… ConfiguraciÃ³n completada"
echo ""
echo "Siguiente paso: Ejecuta ./start-traefik.sh para iniciar con Let's Encrypt"

