#!/bin/bash

# Script para desplegar todos los servicios Docker en su configuraciÃ³n correcta

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸš€ Despliegue de Servicios Docker"
echo "=================================="
echo ""

# Step 1: Ensure Traefik network exists
echo "ğŸ“¡ Paso 1: Verificando red Docker..."
NETWORK_NAME="dannig-network"

if ! docker network inspect "$NETWORK_NAME" &>/dev/null; then
  echo "   Creando red $NETWORK_NAME..."
  docker network create "$NETWORK_NAME"
  echo "   âœ… Red creada"
else
  echo "   âœ… Red $NETWORK_NAME existe"
fi

echo ""

# Step 2: Check current Traefik status
echo "ğŸ“‹ Paso 2: Verificando estado de Traefik..."
if docker ps --format "{{.Names}}" | grep -q "^traefik$"; then
  echo "   âœ… Traefik estÃ¡ corriendo"
  TRAEFIK_RUNNING=true
else
  echo "   âš ï¸  Traefik no estÃ¡ corriendo"
  TRAEFIK_RUNNING=false
fi

echo ""

# Step 3: Configure m3u8-proxy behind Traefik
echo "ğŸ¬ Paso 3: Configurando m3u8-proxy..."
mkdir -p traefik/dynamic-config

cat > traefik/dynamic-config/m3u8-proxy.yml <<'EOF'
# Configuration for m3u8-proxy behind Traefik
# Auto-generated by deploy-services.sh

http:
  middlewares:
    redirect-m3u8-to-https:
      redirectScheme:
        scheme: https
        permanent: true

  routers:
    m3u8-proxy:
      rule: "Host(`m3u8.Dannig-Optica.freeddns.org`)"
      entryPoints:
        - websecure
      service: m3u8-proxy-svc
      tls:
        certResolver: letsencrypt
      priority: 10
    
    m3u8-proxy-http:
      rule: "Host(`m3u8.Dannig-Optica.freeddns.org`)"
      entryPoints:
        - web
      middlewares:
        - redirect-m3u8-to-https
      service: m3u8-proxy-svc
      priority: 10

  services:
    m3u8-proxy-svc:
      loadBalancer:
        servers:
          - url: "http://m3u8-proxy:80"
EOF

echo "   âœ… ConfiguraciÃ³n de Traefik creada: traefik/dynamic-config/m3u8-proxy.yml"

# Connect m3u8-proxy to dannig-network if not already connected
if docker ps --format "{{.Names}}" | grep -q "^m3u8-proxy$"; then
  echo "   Conectando m3u8-proxy a la red $NETWORK_NAME..."
  docker network connect "$NETWORK_NAME" m3u8-proxy 2>/dev/null || echo "     (ya estÃ¡ conectado o error al conectar)"
  echo "   âœ… m3u8-proxy configurado"
else
  echo "   âš ï¸  m3u8-proxy no estÃ¡ corriendo (se configurarÃ¡ cuando se inicie)"
fi

echo ""

# Step 4: Configure Portainer behind Traefik (optional)
echo "ğŸ“Š Paso 4: Configurando Portainer (opcional)..."
read -p "   Â¿Configurar Portainer detrÃ¡s de Traefik? (y/n) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
  cat >> traefik/dynamic-config/portainer.yml <<'EOF'
# Configuration for Portainer behind Traefik

http:
  routers:
    portainer:
      rule: "Host(`portainer.Dannig-Optica.freeddns.org`)"
      entryPoints:
        - websecure
      service: portainer-svc
      tls:
        certResolver: letsencrypt
    
    portainer-http:
      rule: "Host(`portainer.Dannig-Optica.freeddns.org`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: portainer-svc

  services:
    portainer-svc:
      loadBalancer:
        servers:
          - url: "http://portainer:9000"
EOF

  if docker ps --format "{{.Names}}" | grep -q "^portainer$"; then
    docker network connect "$NETWORK_NAME" portainer 2>/dev/null || echo "     (ya estÃ¡ conectado)"
    echo "   âœ… Portainer configurado"
  else
    echo "   âš ï¸  Portainer no estÃ¡ corriendo"
  fi
else
  echo "   â­ï¸  Saltando Portainer"
fi

echo ""

# Step 5: Ensure Traefik is using correct ports
echo "ğŸ”Œ Paso 5: Verificando configuraciÃ³n de puertos..."
if [ -f .env ]; then
  HTTP_PORT=$(grep "^TRAEFIK_HTTP_PORT=" .env | cut -d= -f2 || echo "80")
  HTTPS_PORT=$(grep "^TRAEFIK_HTTPS_PORT=" .env | cut -d= -f2 || echo "443")
else
  HTTP_PORT=80
  HTTPS_PORT=443
fi

echo "   Traefik HTTP port: $HTTP_PORT"
echo "   Traefik HTTPS port: $HTTPS_PORT"

if [ "$HTTP_PORT" != "80" ] || [ "$HTTPS_PORT" != "443" ]; then
  echo ""
  echo "   âš ï¸  ADVERTENCIA: Let's Encrypt requiere puertos 80 y 443"
  echo "   Si usas puertos personalizados, Let's Encrypt NO funcionarÃ¡"
  echo ""
  read -p "   Â¿Cambiar a puertos 80/443 para Let's Encrypt? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [ ! -f .env ]; then
      cat > .env <<EOF
# Traefik Ports Configuration
TRAEFIK_HTTP_PORT=80
TRAEFIK_HTTPS_PORT=443
TRAEFIK_DASHBOARD_PORT=8080

# MySQL Configuration
MYSQL_ROOT_PASSWORD=root
MYSQL_DATABASE=dannig
MYSQL_USER=dannig
MYSQL_PASSWORD=dannig

# Backend Configuration
JWT_SECRET=secure-token-change-in-production
ADMIN_EMAIL=admin@dannig.local
ADMIN_PASSWORD=admin123

# Frontend API URL
VITE_API_URL=https://api.Dannig-Optica.freeddns.org
EOF
    else
      sed -i 's/^TRAEFIK_HTTP_PORT=.*/TRAEFIK_HTTP_PORT=80/' .env
      sed -i 's/^TRAEFIK_HTTPS_PORT=.*/TRAEFIK_HTTPS_PORT=443/' .env
    fi
    echo "   âœ… .env actualizado para usar puertos 80/443"
  fi
fi

echo ""

# Step 6: Stop m3u8-proxy if it's using port 8080 externally
echo "ğŸ”§ Paso 6: Verificando puerto 8080..."
if docker ps --format "{{.Names}} {{.Ports}}" | grep -q "m3u8-proxy.*8080"; then
  echo "   m3u8-proxy estÃ¡ usando puerto 8080 externamente"
  echo "   Para usar Traefik, debe moverse a puerto interno solamente"
  echo ""
  read -p "   Â¿Detener m3u8-proxy para reconfigurarlo? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "   Deteniendo m3u8-proxy..."
    docker stop m3u8-proxy 2>/dev/null || true
    echo "   âœ… m3u8-proxy detenido"
    echo ""
    echo "   ğŸ“ IMPORTANTE: Edita el docker-compose.yml de m3u8-proxy"
    echo "      y elimina o comenta la lÃ­nea de ports: \"8080:80\""
    echo "      Luego reinÃ­cialo con: docker-compose up -d m3u8-proxy"
    echo ""
  fi
fi

echo ""

# Step 7: Start/restart Traefik
echo "ğŸš€ Paso 7: Iniciando/Reiniciando Traefik..."
if [ "$TRAEFIK_RUNNING" = true ]; then
  echo "   Reiniciando Traefik para cargar nueva configuraciÃ³n..."
  docker compose -f docker-compose.traefik.yml restart traefik 2>/dev/null || \
    docker-compose -f docker-compose.traefik.yml restart traefik 2>/dev/null || \
    docker restart dannig-traefik 2>/dev/null
else
  echo "   Iniciando Traefik..."
  docker compose -f docker-compose.traefik.yml up -d traefik 2>/dev/null || \
    docker-compose -f docker-compose.traefik.yml up -d traefik 2>/dev/null
fi

sleep 3

if docker ps --format "{{.Names}}" | grep -q "^traefik$\|^dannig-traefik$"; then
  echo "   âœ… Traefik estÃ¡ corriendo"
else
  echo "   âŒ Error al iniciar Traefik"
  echo "   Verifica los logs: docker compose -f docker-compose.traefik.yml logs traefik"
fi

echo ""

# Step 8: Summary
echo "âœ… Despliegue completado!"
echo ""
echo "ğŸ“‹ Resumen de configuraciÃ³n:"
echo ""
echo "   ğŸŒ Servicios disponibles:"
echo "      - DannigOptica Frontend: https://app.Dannig-Optica.freeddns.org"
echo "      - DannigOptica API: https://api.Dannig-Optica.freeddns.org"
if [ -f traefik/dynamic-config/m3u8-proxy.yml ]; then
  echo "      - m3u8-proxy: https://m3u8.Dannig-Optica.freeddns.org"
fi
if [ -f traefik/dynamic-config/portainer.yml ]; then
  echo "      - Portainer: https://portainer.Dannig-Optica.freeddns.org"
fi
echo "      - Traefik Dashboard: https://dashboard.Dannig-Optica.freeddns.org"
echo ""
echo "   ğŸ” SSL: Let's Encrypt (certificados se emitirÃ¡n automÃ¡ticamente)"
echo ""
echo "   ğŸ“ Para ver logs:"
echo "      docker compose -f docker-compose.traefik.yml logs -f"
echo ""
echo "   ğŸ”„ Para reiniciar todos los servicios:"
echo "      docker compose -f docker-compose.traefik.yml restart"
echo ""

