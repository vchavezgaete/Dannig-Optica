# Docker Compose V2 - versión no necesaria

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.11
    container_name: dannig-traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=dannig-network"
      - "--providers.file.directory=/dynamic-config"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      # Let's Encrypt está bloqueado por rate limit, usando certificados autofirmados temporalmente
      # Para usar Let's Encrypt: cambiar a puertos 80/443 y esperar que expire el rate limit
      # - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
      # - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-v02.api.letsencrypt.org/directory"
      - "--log.level=INFO"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/certs:/certs:ro
      - ./traefik/dynamic-config:/dynamic-config:ro
    networks:
      - dannig-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.dannig-traefik-dashboard.rule=Host(`dashboard.Dannig-Optica.freeddns.org`) || Host(`traefik.Dannig-Optica.freeddns.org`)"
      - "traefik.http.routers.dannig-traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.dannig-traefik-dashboard.tls=true"
      - "traefik.http.routers.dannig-traefik-dashboard.service=api@internal"
      - "traefik.http.routers.dannig-traefik-dashboard.middlewares=auth"
      - "traefik.http.routers.dannig-traefik-dashboard.priority=100"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$aK8Gx6yJ$$Z2l7Y0K8YzY7X1X1X1X1X1"

  # Base de datos MySQL
  mysql:
    image: mysql:8.0
    container_name: dannig-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-D4nnlg-Optlc4-Passw0rd}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-dannig}
      MYSQL_USER: ${MYSQL_USER:-dannig}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-D4nn1g-Us3R}
    command: --default-authentication-plugin=mysql_native_password --sql-mode=""
    networks:
      - dannig-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - mysql_data:/var/lib/mysql

  # Adminer para gestión de BD
  adminer:
    image: adminer
    container_name: dannig-adminer
    networks:
      - dannig-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminer.rule=Host(`db.Dannig-Optica.freeddns.org`)"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls=true"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # Backend API
  backend:
    build: ./backend
    container_name: dannig-backend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=mysql://${MYSQL_USER:-dannig}:${MYSQL_PASSWORD:-D4nn1g-Us3R}@mysql:3306/${MYSQL_DATABASE:-dannig}
      - JWT_SECRET=${JWT_SECRET:-jwt-S3cR3T-D4nN1G-0Pt|c4}
      # Admin user credentials
      - ADMIN_NAME=${ADMIN_NAME:-Admin}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@dannig-optica.cl}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-4dMln-123.@}
      # Captador user credentials
      - CAPTADOR_NAME=${CAPTADOR_NAME:-Captador-Demo}
      - CAPTADOR_EMAIL=${CAPTADOR_EMAIL:-captador@dannig-optica.cl}
      - CAPTADOR_PASSWORD=${CAPTADOR_PASSWORD:-C4pt@D0r.123}
      # Oftalmólogo user credentials
      - OFTALMOLOGO_NAME=${OFTALMOLOGO_NAME:-Dr. Oftalmólogo}
      - OFTALMOLOGO_EMAIL=${OFTALMOLOGO_EMAIL:-oftalmologo@dannig-optica.cl}
      - OFTALMOLOGO_PASSWORD=${OFTALMOLOGO_PASSWORD:-0ft4lm0loG0.123}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - dannig-network
    restart: unless-stopped
    volumes:
      - ./backend/logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`api.Dannig-Optica.freeddns.org`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=3001"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.backend-http.rule=Host(`api.Dannig-Optica.freeddns.org`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Frontend React
  frontend:
    build:
      context: ./frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-https://api.Dannig-Optica.freeddns.org}
    container_name: dannig-frontend
    depends_on:
      - backend
    networks:
      - dannig-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dannig-frontend.rule=Host(`app.Dannig-Optica.freeddns.org`) || Host(`app.dannig-optica.freeddns.org`) || Host(`Dannig-Optica.freeddns.org`) || Host(`dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-frontend.entrypoints=websecure"
      - "traefik.http.routers.dannig-frontend.tls=true"
      - "traefik.http.routers.dannig-frontend.priority=100"
      - "traefik.http.routers.dannig-frontend.service=dannig-frontend-svc"
      - "traefik.http.services.dannig-frontend-svc.loadbalancer.server.port=80"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.dannig-frontend-http.rule=Host(`app.Dannig-Optica.freeddns.org`) || Host(`app.dannig-optica.freeddns.org`) || Host(`Dannig-Optica.freeddns.org`) || Host(`dannig-optica.freeddns.org`)"
      - "traefik.http.routers.dannig-frontend-http.entrypoints=web"
      - "traefik.http.routers.dannig-frontend-http.middlewares=redirect-dannig-frontend-to-https"
      - "traefik.http.middlewares.redirect-dannig-frontend-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-dannig-frontend-to-https.redirectscheme.permanent=true"

volumes:
  mysql_data:
    driver: local

networks:
  dannig-network:
    driver: bridge

